{# templates/timetable/schedule_table.html #}
{% set settings = get_settings() %}
{% set is_mobile_enabled = settings.appearance.mobile_view %}
<!-- Десктопная версия -->
<div class="{% if settings.appearance.mobile_view %}hidden md:block{% else %}block{% endif %}">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0 sm:p-4">
            <div class="mb-4 px-4">
                {% if schedule_type == 'group' %}
                    <h2 class="card-title">Расписание группы {{ value }}</h2>
                {% elif schedule_type == 'teacher' %}
                    <h2 class="card-title">Расписание преподавателя {{ value }}</h2>
                {% else %}
                    <h2 class="card-title">Расписание аудитории {{ value }}</h2>
                {% endif %}
            </div>

            <div class="overflow-x-auto">
                <div style="min-width: 1200px">
                    <table class="table w-full border-collapse">
                        <thead class="sticky top-0 bg-base-100">
                        <tr>
                            <th class="w-32 min-w-[128px]">Время</th>
                            <th class="w-[180px] min-w-[180px]">Понедельник</th>
                            <th class="w-[180px] min-w-[180px]">Вторник</th>
                            <th class="w-[180px] min-w-[180px]">Среда</th>
                            <th class="w-[180px] min-w-[180px]">Четверг</th>
                            <th class="w-[180px] min-w-[180px]">Пятница</th>
                            <th class="w-[180px] min-w-[180px]">Суббота</th>
                        </tr>
                        </thead>
                        {% set settings = get_settings() %}
                        <tbody>
                        {% for slot in settings.time_slots %}
                            <tr>
                                <td class="border px-2 py-1 font-medium bg-base-200 w-32 min-w-[128px]">
                                    {{ slot.start }} - {{ slot.end }}
                                </td>
                                {% for day in range(1, 7) %}
                                    <td class="border p-2 align-top min-h-24 w-[180px] min-w-[180px]">
                                        {% set displayed_lessons = [] %}
                                        {% for lesson in schedule %}
                                            {% if lesson.weekday == day and lesson.get_lesson_number() == slot.number %}
                                                {% set lesson_key = lesson.subject + lesson.lesson_type + lesson.teacher_name + lesson.auditory %}
                                                {% if lesson_key not in displayed_lessons %}
                                                    {% set _ = displayed_lessons.append(lesson_key) %}

                                                    {# Собираем все похожие занятия #}
                                                    {% set similar_lessons = [] %}
                                                    {% for other_lesson in schedule %}
                                                        {% if other_lesson.weekday == day and
                              other_lesson.get_lesson_number() == slot.number and
                              other_lesson.subject == lesson.subject and
                              other_lesson.teacher_name == lesson.teacher_name and
                              other_lesson.lesson_type == lesson.lesson_type and
                              other_lesson.auditory == lesson.auditory %}
                                                            {% set _ = similar_lessons.append(other_lesson) %}
                                                        {% endif %}
                                                    {% endfor %}

                                                    <div class="mb-2 p-2 rounded-lg {% if not settings.appearance.minimal_style %}text-white{% endif %}"
                                                         style="background-color:

                                                                 {% if not settings.appearance.minimal_style %}{{ get_lesson_color(lesson.lesson_type) }}{% endif %}">
                                                        <div class="font-bold">{{ lesson.subject }}</div>
                                                        <div class="text-sm">
                                                            <div class="flex items-center gap-2">
                                <span class="badge badge-sm {% if settings.appearance.minimal_style %}text-white{% else %}bg-white/20 border-0{% endif %}"
                                      style="background-color:

                                              {% if settings.appearance.minimal_style %}{{ get_lesson_color(lesson.lesson_type) }}{% endif %}">
                                    {{ lesson.lesson_type }}
                                    {% if lesson.subgroup and lesson.subgroup != '0' %}
                                        ({{ lesson.subgroup }})
                                    {% endif %}
                                </span>
                                                            </div>

                                                            {% if schedule_type != 'teacher' %}
                                                                <div>
                                                                    <a href="{{ url_for('main.schedule', type='teacher', value=lesson.teacher_name) }}"
                                                                       class="{% if settings.appearance.minimal_style %}hover:underline{% else %}text-white hover:text-blue-200{% endif %}">
                                                                        {{ lesson.teacher_name }}
                                                                    </a>
                                                                </div>
                                                            {% endif %}

                                                            {% if schedule_type != 'room' %}
                                                                <div>
                                                                    <a href="{{ url_for('main.schedule', type='room', value=lesson.auditory) }}"
                                                                       class="{% if settings.appearance.minimal_style %}hover:underline{% else %}text-white hover:text-blue-200{% endif %}">
                                                                        ауд. {{ lesson.auditory }}
                                                                    </a>
                                                                </div>
                                                            {% endif %}

                                                            {% if schedule_type != 'group' %}
                                                                <div class="text-sm">
                                                                    Группы:
                                                                    {% for sl in similar_lessons %}
                                                                        <a href="{{ url_for('main.schedule', type='group', value=sl.group_name) }}"
                                                                           class="{% if settings.appearance.minimal_style %}hover:underline{% else %}text-white hover:text-blue-200{% endif %}">
                                                                            {{ sl.group_name }}{% if not loop.last %}
                                                                                , {% endif %}
                                                                        </a>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Мобильная версия -->
<!-- Мобильная версия -->

<div class="{% if settings.appearance.mobile_view %}md:hidden block{% else %}hidden{% endif %}">
    <div class="mb-4">
        {% if schedule_type == 'group' %}
            <h2 class="card-title">Расписание группы {{ value }}</h2>
        {% elif schedule_type == 'teacher' %}
            <h2 class="card-title">Расписание преподавателя {{ value }}</h2>
        {% else %}
            <h2 class="card-title">Расписание аудитории {{ value }}</h2>
        {% endif %}
    </div>

    {% set days = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'] %}

    <div class="space-y-4">
        {% for day_name in days %}
            {% set day_number = loop.index %}
            <div class="collapse collapse-arrow bg-base-200">
                <input type="radio" name="day-accordion" {% if (weekday or 1) == day_number %}checked{% endif %}/>
                <div class="collapse-title text-xl font-medium">
                    {{ day_name }}
                </div>
                <div class="collapse-content">
                    {% set has_lessons = false %}
                    {% for slot in settings.time_slots %}
                        <div class="mb-6 p-3 bg-base-300/30 rounded-lg">
                            <div class="text-sm font-medium mb-2">
                                {{ slot.number }} пара | {{ slot.start }} - {{ slot.end }}
                            </div>

                            {% set displayed_lessons = [] %}
                            {% for lesson in schedule %}
                                {% if lesson.weekday == day_number and lesson.get_lesson_number() == slot.number %}
                                    {% set lesson_key = lesson.subject + lesson.lesson_type + lesson.teacher_name + lesson.auditory %}
                                    {% if lesson_key not in displayed_lessons %}
                                        {% set _ = displayed_lessons.append(lesson_key) %}
                                        {% set has_lessons = true %}

                                        {% set similar_lessons = [] %}
                                        {% for other_lesson in schedule %}
                                            {% if other_lesson.weekday == day_number and
                                                  other_lesson.get_lesson_number() == slot.number and
                                                  other_lesson.subject == lesson.subject and
                                                  other_lesson.teacher_name == lesson.teacher_name and
                                                  other_lesson.lesson_type == lesson.lesson_type and
                                                  other_lesson.auditory == lesson.auditory %}
                                                {% set _ = similar_lessons.append(other_lesson) %}
                                            {% endif %}
                                        {% endfor %}

                                        <div class="card mb-2 last:mb-0">
                                            <div class="card-body p-4 {% if not settings.appearance.minimal_style %}text-white{% endif %}"
                                                 style="background-color: {% if not settings.appearance.minimal_style %}{{ get_lesson_color(lesson.lesson_type) }}{% endif %}">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h3 class="font-bold">{{ lesson.subject }}</h3>
                                                    <span class="badge {% if settings.appearance.minimal_style %}text-white{% else %}bg-white/20 border-0{% endif %}"
                                                          style="background-color: {% if settings.appearance.minimal_style %}{{ get_lesson_color(lesson.lesson_type) }}{% endif %}">
                                                        {{ lesson.lesson_type }}
                                                        {% if lesson.subgroup and lesson.subgroup != '0' %}
                                                            ({{ lesson.subgroup }})
                                                        {% endif %}
                                                    </span>
                                                </div>

                                                <div class="mt-2 space-y-1">
                                                    {% if schedule_type != 'teacher' %}
                                                        <div>
                                                            <a href="{{ url_for('main.schedule', type='teacher', value=lesson.teacher_name) }}"
                                                               class="{% if settings.appearance.minimal_style %}hover:underline{% else %}text-white hover:text-blue-200{% endif %}">
                                                                {{ lesson.teacher_name }}
                                                            </a>
                                                        </div>
                                                    {% endif %}

                                                    {% if schedule_type != 'room' %}
                                                        <div>
                                                            <a href="{{ url_for('main.schedule', type='room', value=lesson.auditory) }}"
                                                               class="{% if settings.appearance.minimal_style %}hover:underline{% else %}text-white hover:text-blue-200{% endif %}">
                                                                ауд. {{ lesson.auditory }}
                                                            </a>
                                                        </div>
                                                    {% endif %}

                                                    {% if schedule_type != 'group' and similar_lessons|length > 0 %}
                                                        <div>
                                                            Группы:
                                                            {% for sl in similar_lessons %}
                                                                <a href="{{ url_for('main.schedule', type='group', value=sl.group_name) }}"
                                                                   class="{% if settings.appearance.minimal_style %}hover:underline{% else %}text-white hover:text-blue-200{% endif %}">
                                                                    {{ sl.group_name }}{% if not loop.last %}, {% endif %}
                                                                </a>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if not displayed_lessons %}
                                <div class="text-center py-2 text-gray-500">
                                    Нет занятий
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}

                    {% if not has_lessons %}
                        <div class="text-center py-4 text-gray-500">
                            Нет занятий в этот день
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Получаем сохраненный день или используем системный
    let savedDay = localStorage.getItem('selectedDay');
    const systemDay = new Date().getDay() || 7; // 0 (воскресенье) -> 7
    const currentDay = savedDay || (systemDay > 6 ? 1 : systemDay);
    const mobileViewEnabled = {{ 'true' if settings.appearance.mobile_view else 'false' }};

    if (!mobileViewEnabled) {
        // If mobile view is disabled, ensure desktop version is always shown
        const mobileVersion = document.querySelector('.md\\:hidden');
        const desktopVersion = document.querySelector('.hidden.md\\:block');

        if (mobileVersion) {
            mobileVersion.classList.add('hidden');
            mobileVersion.classList.remove('block');
        }

        if (desktopVersion) {
            desktopVersion.classList.remove('hidden');
            desktopVersion.classList.add('block');
        }
    }

    // Находим нужный input и устанавливаем его checked
    const dayInputs = document.querySelectorAll('input[name="day-accordion"]');
    const targetInput = dayInputs[currentDay - 1];
    if (targetInput) {
        targetInput.checked = true;
    }

    // Сохраняем выбранный день при изменении
    dayInputs.forEach((input, index) => {
        input.addEventListener('change', function() {
            if (this.checked) {
                localStorage.setItem('selectedDay', index + 1);
            }
        });
    });
});
</script>